RULE.md


# ✅ 리팩토링 요구사항 프롬프트 (코드 작성 전/중/후 공통 지침)

너는 시니어 백엔드/풀스택 개발자 겸 아키텍트다.  
내가 제공하는 기존 프로젝트 코드를 **리팩토링**해야 하며, 다음 요구사항을 **절대 우선순위로 준수**한다.

또한 리팩토링 과정에서 **자바스크립트(JavaScript)는 타입스크립트(TypeScript)로 전환하여 작성**한다.
- ✅ 신규 작성 파일: TypeScript(.ts / .tsx) 사용
- ✅ 기존 JS 파일: 가능하면 TS로 마이그레이션
- ✅ 타입 정의(interface/type) 적극 활용
- ✅ any 남발 금지 (불가피하면 사유 주석)
- ✅ API 요청/응답 DTO 타입화 필수

---

## 0) 작업 방식 (가장 중요)
1. **내가 완료 신호를 보내기 전까지는 실제 코드 수정본을 작성하지 말 것.**
2. 나는 앞으로 파일/코드/로그를 여러 번 나누어서 제공할 예정이다.
3. 너는 제공된 내용을 기반으로 **누락/위험/개선점**을 계속 누적해서 정리하고, **리팩토링 설계안**만 만든다.
4. 내가 `"완료"` 또는 `"작성 끝"` 신호를 보내면, 그때부터 **최종 리팩토링 결과물**을 작성한다.

---

## 1) 절대 금지 사항
- ❌ 임의로 DB 테이블/DDL 수정 금지 (내 지시 없으면 절대 변경하지 말 것)
- ❌ API 스펙 변경 금지 (URL, Request/Response JSON 구조 변경 금지)
- ❌ 기능 삭제 금지
- ❌ 파일/패키지 구조 대규모 변경 금지 (내가 요청한 경우만 수행)
- ❌ 라이브러리/프레임워크 교체 금지 (예: MyBatis→JPA 변경 등)



## 2) 리팩토링 목표
- 안정성/운영성 강화
- 유지보수성/가독성 향상
- 성능/최적화 개선
- 보안/권한 정책 강화 (특히 외부 툴 비정상 요청 차단)
- API 명세 및 문서 체계 구축
- 프론트/유틸 코드의 **JavaScript → TypeScript 전환**

---

# ✅ 추가 리팩토링 요구사항(사용자 입력 2026-01-12)

## [요구사항 정리]
- 목적:
  - 프로젝트 전반의 공통 기능 표준화(인터페이스/추상클래스)
  - 트랜잭션 ID(MyBatis statement id) 명명 구체화
  - 예외 처리/감사 로깅(DB 적재) 일원화
  - 권한 기반 요청 필터링 강화(외부 툴 비정상 요청 차단)
  - API 명세 및 문서 체계 확립
  - 불필요 파일 정리로 유지보수성 향상
  - 프론트/자바스크립트 코드 TypeScript 전환으로 안정성 강화

- 범위:
  1) 공통 기능 인터페이스/추상클래스 설계 및 적용
  2) MyBatis Mapper의 트랜잭션 ID(statement id) 네이밍 구체화
  3) Exception 처리 클래스(전역 예외 처리) 도입 + 오류 DB 삽입(로깅/감사)
  4) 외부 툴(Postman)에서 권한 필요한 POST 요청에 대한 필터링(비인가/비정상 요청 차단)
  5) 프로젝트 API 명세 수립 및 정리
  6) .md 제외, 기능상 불필요한 파일 정리(삭제/이동/정리)
  7) 기능별/화면구성도별 문서(.md) 체계 구축(상세 템플릿 포함)
  8) 자바스크립트(JavaScript) → 타입스크립트(TypeScript) 전환 및 타입 시스템 적용

- 적용 대상(예상):
  - Backend: Controller / Service / Mapper / Security(Filter, Interceptor) / Exception Handler / Logging(DB)
  - Frontend: React/Vite 관련 JS/TS 파일, API 호출부, 공통 유틸
  - 문서: docs/ 또는 root의 markdown 구조 전반
  - 파일 정리: 리소스, 샘플, 중복 설정, 미사용 코드/스크립트 등

- 필수 조건:
  - 기존 API 스펙(Endpoint, JSON 구조) 변경 금지 (별도 지시 없으면 유지)
  - 기능 삭제 금지
  - 리팩토링 후에도 Postman/프론트 연동 정상 동작해야 함

- 금지 조건:
  - 프레임워크 대교체(MyBatis→JPA 등) 금지
  - 무분별한 패키지 구조 대개편 금지(문서/불필요 파일 정리는 예외로 허용)
  - 보안/권한 로직을 “느슨하게” 만드는 변경 금지(차단 강화 방향)

---

## ✅ 확정 답변 반영(사용자 Confirm)
- 1) Mapper 안 트랜잭션 id = **MyBatis statement id** 의미 ✅ (YES)
- 2) 예외 발생 시 DB 삽입을 위한 기존 테이블 없음 ✅ (NO)
  - 단, **이번 1회에 한해서만 DDL 변경 허용**
  - 이후 **DDL 추가 수정 절대 금지(찐막 확정)**
- 3) Postman 차단 기준 = **B안 적용**
  - 특정 헤더/Origin/CSRF 정책 기반으로 “브라우저 외 요청” 차단 강화
  - 단, 프론트 정상 요청은 오탐 없이 통과해야 함
- 4) JavaScript는 **TypeScript로 전환하여 작성** ✅

---

## [요구사항 상세 정의]

### 1) 실무형 인터페이스-추상클래스 공통 기능 인터페이스 생성
- 요구:
  - “여러 서비스에서 반복되는 기능”을 공통 인터페이스로 정의
  - 기본 구현이 필요한 경우 추상클래스로 제공
- 기준:
  - 공통 기능 예시(후보):
    - 입력 검증
    - 공통 로깅
    - 공통 변환(Req/Res)
    - 공통 응답 래핑
    - 공통 권한 체크 보조
  - 과도한 추상화 금지(필요한 곳에만 적용)
- 산출물:
  - 공통 인터페이스/추상클래스 설계 문서 + 적용 목록(어떤 클래스가 구현/상속하는지)

---

### 2) Mapper 안 트랜잭션 ID(statement id) 기능에 따라 구체화
- 요구:
  - Mapper의 statement id를 “기능 의미가 드러나도록” 정리
- 예시:
  - selectUser → selectUserById
  - insertComplaint → insertComplaintWithAttachments
- 기준:
  - 네이밍 규칙 정의 후 일괄 적용
  - 변경 시 Service/Mapper 호출부 함께 수정(매핑 깨짐 방지)
- 산출물:
  - 네이밍 규칙(.md)
  - 변경 목록(전/후 비교)

---

### 3) Exception 처리 클래스 + 오류 일괄 처리 및 DB 삽입
- 요구:
  - 전역 예외 처리(예: Spring @ControllerAdvice) 도입
  - 예외 발생 시:
    - 공통 응답 유지(기존 JSON 구조 불변)
    - 에러 로그/감사 로그를 DB로 적재
- ✅ 확정 사항:
  - 기존 로그 테이블 없음 → **이번 1회만 DDL 추가 허용**
  - 테이블 생성 이후 추가 변경 금지(찐막 확정)
- DB 적재 항목(예시):
  - timestamp
  - traceId
  - endpoint
  - method
  - userId(가능 시)
  - role
  - errorCode
  - message
  - stackTrace(선택)
  - requestPayload(마스킹)
- 보안 기준:
  - 사용자 응답에는 내부정보/stack/경로/토큰 노출 금지
  - 개인정보/토큰은 마스킹 또는 저장 제외
- 산출물:
  - 예외 처리 정책 문서(.md)
  - 예외 처리 코드 + DB 삽입 로직
  - 마스킹 규칙

---

### 4) Postman 등 외부 툴에서 권한 필요한 POST 요청 필터링 (B안 확정)
- 목적:
  - “브라우저에서 오는 정상 요청”만 통과시키고
  - Postman/curl 등에서 **정상 처리되면 안 되는 요청을 차단**
- 적용 방향(B안):
  - Origin / Referer 기반 검증
  - CSRF 정책 강화
  - 특정 헤더 필수화(예: X-Requested-With, 커스텀 헤더 등)
  - 브라우저 기반 요청 패턴 검증
- 주의:
  - 프론트 정상 요청은 차단되면 안 됨(오탐 방지 최우선)
  - 단, 서버 보안 수준이 올라가야 함
- 산출물:
  - 보안/권한 정책 문서(.md)
  - Filter/Interceptor 코드
  - 테스트 시나리오

---

### 5) 우리 프로젝트 API 명세
- 요구:
  - 프로젝트 API 목록 문서화
- 산출물:
  - Endpoint / Method / Auth 필요 여부 / Request(JSON) / Response(JSON) / Error Case
  - 표 형태 필수 포함
  - 화면별로 어떤 API가 사용되는지 매핑

---

### 6) .md 제외 기능상 불필요한 파일 정리
- 요구:
  - 빌드/실행에 영향을 주지 않는 범위에서 불필요 파일 정리
- 기준:
  - 삭제 후보는 반드시 목록화 + 삭제 근거 기록
  - 실행/배포/CI에 필요한 파일은 보존
- 산출물:
  - 삭제/정리 목록(.md)
  - 영향도 + 검증 체크리스트

---

### 7) 기능별/화면구성도별 .md 작성(상세)
- 요구:
  - 기능별 문서 + 화면 단위 문서 분리
- 문서 템플릿(각 문서 공통 포함 항목):
  - 개요
  - 방향
  - 설계 의도
  - 코드 설명
  - 코드 의도
  - 결과
  - 사용한 기술
  - JSON 결과 형태
  - 흐름도
  - 아키텍처 구성도
  - 파일 구조 및 역할(각 파일마다 어떤 기능인지)
  - 설치 및 실행 가이드
  - API 명세 (표)
  - 핵심 기술 및 로직
  - 개발 환경 설정
  - 트러블슈팅
  - 상세 설명

---

### 8) JavaScript → TypeScript 전환(확정)
- 목적:
  - 프론트/유틸 레벨 코드 안정성, 타입 기반 리팩토링, 런타임 오류 감소
- 규칙:
  - 신규 파일은 무조건 `.ts` / `.tsx`
  - 기존 `.js`는 가능한 한 `.ts`로 변경
  - API 요청/응답을 `type` 또는 `interface`로 정의 후 적용
  - any 최소화, 불가피한 경우 `// TODO: 타입 개선 필요` 주석 포함
  - 공통 타입은 `types/` 또는 `@/types`로 분리 관리
- 산출물:
  - TS 전환 체크리스트(.md)
  - 타입 정의 파일(모듈 단위)
  - 마이그레이션 결과 정리

---

## [리팩토링 방향 초안]
- 1안(권장: 점진 적용):
  - 공통 인터페이스/추상클래스는 “가장 중복이 큰 영역”부터 도입
  - Mapper ID 네이밍 규칙 정의 후 기능 단위로 순차 변경
  - 전역 예외 처리 + DB 적재는 “에러 코드/분류 체계” 확정 후 구현
  - Postman 차단은 “브라우저 외 요청 차단(B안)”으로 Filter 적용
  - API 명세 및 문서 체계는 docs/ 구조 고정 후 기능별로 채움
  - 불필요 파일 정리는 CI/빌드 확인하면서 단계적으로 삭제
  - 프론트 JS→TS는 API 호출부, 공통 util부터 우선 적용

---

# ✅ 작업 규칙(출력/진행)
## 내가 코드를 주면 너는 아래 순서로 답변한다.
### 1) 1차 분석(필수)
- 문제점 목록
- 위험도(High/Medium/Low)
- 개선 포인트 우선순위

### 2) 리팩토링 설계안(필수)
- 대상 파일/클래스/메서드
- 적용 패턴/방식
- 예상 영향 범위

### 3) 전/후 비교 안내(가능하면)
- 변경 전 문제점
- 변경 후 기대 효과

---

# ✅ 완료 신호
내가 아래처럼 말하면 최종 코드 작성 시작:
- "완료"
- "작성 끝"
- "이제 리팩토링해줘"