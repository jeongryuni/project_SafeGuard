<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.safeguard.mapper.ComplaintMapper">

    <!-- 민원 목록 조회 (기관 필터 포함) -->
    <select id="selectComplaintList" resultType="com.safeguard.dto.ComplaintDTO">
        SELECT
            c.complaint_no AS complaintNo,
            c.title,
            c.category,
            c.status,
            c.created_date AS createdDate,
            c.address,
            c.is_public AS isPublic,
            c.like_count AS likeCount,
            ca.agency_no AS agencyNo
        FROM complaint c
        LEFT JOIN complaint_agency ca
            ON c.complaint_no = ca.complaint_no
        <where>
            <if test="search != null and search != ''">
                AND (c.title ILIKE CONCAT('%', #{search}, '%')
                 OR c.content ILIKE CONCAT('%', #{search}, '%'))
            </if>
            <if test="category != null and category != '전체'">
                AND c.category = #{category}
            </if>
            <if test="status != null and status != '전체'">
                AND c.status = #{status}
            </if>
            <if test="agencyNo != null">
                AND ca.agency_no = #{agencyNo}
            </if>
        </where>
        ORDER BY c.complaint_no DESC
    </select>

    <!-- 민원 상세 -->
    <select id="findByComplaintNo" resultType="com.safeguard.dto.ComplaintDTO">
        SELECT
            c.complaint_no AS complaintNo,
            c.title,
            c.content,
            c.category,
            c.status,
            c.created_date AS createdDate,
            c.address,
            c.latitude,
            c.longitude,
            c.image_path AS imagePath,
            c.answer,
            c.is_public AS isPublic,
            c.like_count AS likeCount,
            ca.agency_no AS agencyNo
        FROM complaint c
        LEFT JOIN complaint_agency ca
            ON c.complaint_no = ca.complaint_no
        WHERE c.complaint_no = #{complaintNo}
    </select>

    <!-- 시드용 민원 등록 -->
    <insert id="insertComplaintDto"
            parameterType="com.safeguard.dto.ComplaintDTO"
            useGeneratedKeys="true"
            keyProperty="complaintNo">
        INSERT INTO complaint (
            title, content, category, status,
            is_public, user_no, created_date,
            address, latitude, longitude,
            image_path, like_count
        ) VALUES (
            #{title}, #{content}, #{category}, #{status},
            #{isPublic}, #{userNo}, #{createdDate},
            #{address}, #{latitude}, #{longitude},
            #{imagePath}, #{likeCount}
        )
    </insert>
    <!-- Shared Where Clause -->
    <sql id="SharedWhere">
        <where>
            <if test="search != null and search != ''">
                AND (c.title ILIKE CONCAT('%', #{search}, '%')
                 OR c.content ILIKE CONCAT('%', #{search}, '%'))
            </if>
            <if test="category != null and category != '전체'">
                AND c.category = #{category}
            </if>
            <if test="status != null and status != '전체'">
                AND c.status = #{status}
            </if>
            <if test="agencyNo != null">
                AND ca.agency_no = #{agencyNo}
            </if>
        </where>
    </sql>

    <select id="findAll" resultType="com.safeguard.dto.ComplaintDTO">
        SELECT
            c.complaint_no AS complaintNo,
            c.title,
            c.category,
            c.status,
            c.created_date AS createdDate,
            c.address,
            c.is_public AS isPublic,
            c.like_count AS likeCount,
            ca.agency_no AS agencyNo,
            a.agency_name AS agencyName
        FROM complaint c
        LEFT JOIN complaint_agency ca
            ON c.complaint_no = ca.complaint_no
        LEFT JOIN agency a
            ON ca.agency_no = a.agency_no
        <include refid="SharedWhere"/>
        ORDER BY
        <choose>
            <when test="sort == 'like_count'">c.like_count</when>
            <when test="sort == 'complaint_no'">c.complaint_no</when>
            <otherwise>c.created_date</otherwise>
        </choose>
        <choose>
            <when test="order == 'ASC'">ASC</when>
            <otherwise>DESC</otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countAll" resultType="long">
        SELECT COUNT(*)
        FROM complaint c
        LEFT JOIN complaint_agency ca
            ON c.complaint_no = ca.complaint_no
        <include refid="SharedWhere"/>
    </select>

    <select id="isLikedByUser" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 FROM complaint_like
            WHERE complaint_no = #{complaintNo} AND user_no = #{userNo}
        )
    </select>

    <update id="updateStatus">
        UPDATE complaint
        SET status = #{status}
        WHERE complaint_no = #{complaintNo}
    </update>

    <update id="updateAnswer">
        UPDATE complaint
        SET answer = #{answer}
        WHERE complaint_no = #{complaintNo}
    </update>

    <select id="checkUserLike" resultType="int">
        SELECT COUNT(*)::int
        FROM complaint_like
        WHERE complaint_no = #{complaintNo} AND user_no = #{userNo}
    </select>

    <insert id="insertLike">
        INSERT INTO complaint_like (complaint_no, user_no)
        VALUES (#{complaintNo}, #{userNo})
    </insert>

    <delete id="deleteLike">
        DELETE FROM complaint_like
        WHERE complaint_no = #{complaintNo} AND user_no = #{userNo}
    </delete>

    <update id="updateLikeCount">
        UPDATE complaint
        SET like_count = COALESCE(like_count, 0) + 1
        WHERE complaint_no = #{complaintNo}
    </update>

    <update id="decreaseLikeCount">
        UPDATE complaint
        SET like_count = GREATEST(COALESCE(like_count, 0) - 1, 0)
        WHERE complaint_no = #{complaintNo}
    </update>

    <select id="selectTopLikedComplaints" resultType="com.safeguard.dto.ComplaintDTO">
        SELECT * FROM complaint
        ORDER BY like_count DESC
        LIMIT 5
    </select>

    <select id="selectComplaintStats" resultType="map">
        SELECT status, COUNT(*) as count
        FROM complaint
        <where>
            <if test="agencyNo != null">
                AND agency_no = #{agencyNo}
            </if>
        </where>
        GROUP BY status
    </select>

    <select id="selectComplaintListByUserNo" resultType="com.safeguard.dto.ComplaintDTO">
        SELECT * FROM complaint
        WHERE user_no = #{userNo}
        ORDER BY created_date DESC
    </select>


    <!-- 기관 매핑 -->
    <insert id="insertComplaintAgency">
        INSERT INTO complaint_agency (complaint_no, agency_no)
        VALUES (#{complaintNo}, #{agencyNo})
    </insert>

    <delete id="deleteAllLikes">
        DELETE FROM complaint_like
    </delete>

    <delete id="deleteAllComplaints">
        DELETE FROM complaint
    </delete>

</mapper>
